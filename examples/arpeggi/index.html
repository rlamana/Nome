<!DOCTYPE html>
<html>
    <head>
        <title>Monome Arpeggi</title>
        <style>
            #grid {
                width: 336px;
            }

            #grid .square {
                display: inline-block;
                background-color: black;
                width: 40px;
                height: 40px;

                margin-left: 2px;
            }

            #grid .square.active {
                background-color: red;
            }
        </style>
    </head>
    <body>
        <div id="grid"></div>

        <script type="text/javascript" src="../../build/dist/nome.js"></script>

        <script src="music.js"></script>
        <script src="timbre.js"></script>

        <script type="text/javascript">
            const KEY = 'C';
            const SCALE = 'major'; //'natural minor';

            const MAX_FREQ = 2100.0;

            var w = 8, h = 8;
            var monome = new Nome.Device();
            var grid = [];

            monome.connect().on('connected', function() {});
            monome.on('key', function(x,y, active) {
                var key = grid[y][x];

                if(active) {
                    monome.led(x, y, 1);
                    key.button && key.button.classList.add('active');
                    key.sound.play();

                    console.log(key.note.latin(), key.note.octave(), key.note.frequency());
                }
                else {
                    monome.led(x, y, 0);
                    key.button && key.button.classList.remove('active');
                    key.sound.pause();
                }
            });

            document.addEventListener("DOMContentLoaded", function(event) {
                var rootElement = document.getElementById('grid'),
                    height = h,
                    width = w,
                    square, 
                    scale, note;

                for(var i=0; i<width; i++) {
                    grid[i] = [];
                    scale = Note.fromLatin(KEY + (i+1)).scale(SCALE);

                    for(var j=0; j<height; j++) {
                        square = document.createElement('div');
                        square.id = 'square#' + (i*width+j);
                        square.className = 'square';
                        rootElement.appendChild(square);

                        note = scale[j];

                        grid[i][j] = {
                            button: square,
                            sound: T("sin", {
                                freq: note.frequency() < MAX_FREQ ? note.frequency() : 0, 
                                wave:"saw", 
                                mul: 0.15
                            }),
                            note: note
                        }
                    }
                }
            });
        </script>
    </body>
</html>
